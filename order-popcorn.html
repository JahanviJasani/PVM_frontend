<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>PopTalk | Order Popcorn</title>
		<meta content="width=device-width, initial-scale=1.0" name="viewport">

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://i.icomoon.io/public/temp/c9cfe9523b/PVM_frontend/style.css">

		<!-- Stylesheets -->
		 <link href="css/core.css" rel="stylesheet">
		 <link href="css/style.css" rel="stylesheet">
	</head>
	<body>
		<div class="screen__wrapper d-flex">
			<!-- ======= Header ======= -->
			<header class="header">
				<div class="container d-flex justify-content-between align-items-center h-100">
					<div class="logo h-100">
						<img alt="Poptalk Logo" class="logo__img" src="img/poptalk_logo.png">
					</div>
					<div class="d-flex align-items-center">
						<a href="/"><i class="icon-home header__icon me-18"></i></a>
						<div class="relative">
							<a class="d-block" href="/"><i class="icon-cart header__icon"></i></a>
							<span id="items-selected-count" class="items__count d-flex align-items-center justify-content-center">2</span>
						</div>
					</div>
				</div>
			</header>

			<!-- ======= Content ======= -->
			<section class="content d-flex flex-column justify-content-between">
				<div class="order__popcorn d-flex align-items-center flex-1 mt-32 mb-32">
					<div class="container">
						<div class="section__header">
							<h1 class="section__title title--one">CHOOSE YOUR POPCORN</h1>
						</div>
						<div class="row justify-content-center"> 
							<!-- ======= Popcorn Blocks ======= -->
							<div class="col-auto">
								<div class="popcorn__block">
									<div class="pc__block--content">
										<img class="popcorn__img mb-10" src="img/salt_popcorn.png" alt="Salt Popcorn">
										<h3 class="title--two mb-10">SALT POPCORN</h3>
										<span data-unit="125" data-qty-target="qty-1" class="d-inline-block popcorn__price">Rs. <span class="price-value">0</span>/-</span>
									</div>
									<div class="popcorn__count d-flex align-items-center justify-content-between">
										<i class="count__icons icon-minus qty-minus" data-target="qty-1"></i>
										<span id="qty-1" class="d-block popcorn__qty">0</span>
										<i class="count__icons icon-plus qty-plus" data-target="qty-1"></i>
									</div>
								</div>
							</div>
							<div class="col-auto">
								<div class="popcorn__block">
									<div class="pc__block--content">
										<img class="popcorn__img mb-10" src="img/salt_popcorn.png" alt="Salt Popcorn">
										<h3 class="title--two mb-10">CARAMEL POPCORN</h3>
										<span data-unit="125" data-qty-target="qty-2" class="d-inline-block popcorn__price">Rs. <span class="price-value">0</span>/-</span>
									</div>
									<div class="popcorn__count d-flex align-items-center justify-content-between">
										<i class="count__icons icon-minus qty-minus" data-target="qty-2"></i>
										<span id="qty-2" class="d-block popcorn__qty">0</span>							
										<i class="count__icons icon-plus qty-plus" data-target="qty-2"></i>			
									</div>
								</div>
							</div>
							<div class="col-auto">
								<div class="popcorn__block">
									<div class="pc__block--content">
										<img class="popcorn__img mb-10" src="img/salt_popcorn.png" alt="Salt Popcorn">
										<h3 class="title--two mb-10">CHEESE POPCORN</h3>
										<span data-unit="125" data-qty-target="qty-3" class="d-inline-block popcorn__price">Rs. <span class="price-value">0</span>/-</span>
									</div>
									<div class="popcorn__count d-flex align-items-center justify-content-between">
										<i class="count__icons icon-minus qty-minus" data-target="qty-3"></i>
										<span id="qty-3" class="d-block popcorn__qty">0</span>
										<i class="count__icons icon-plus qty-plus" data-target="qty-3"></i>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="promotions">
					<div class="container">
						<div class="row">
							<!-- ======= Promotion Blocks ======= -->
							<div class="col-3">
								<img src="img/50_percent_discount.png" alt="">
							</div>
							<div class="col-3">
								<img src="img/launch_discount_offers.png" alt="">
							</div>
							<div class="col-3">
								<img src="img/pay_for_two_offer.png" alt="">
							</div>
							<div class="col-3">
								<img src="img/50_percent_discount_drinks.png" alt="">
							</div>
						</div>
					</div>
				</div>
			</section>

			<!-- ======= Footer ======= -->
			<footer class="footer">
				<div class="container d-flex align-items-center justify-content-between h-100">
					<div class="footer__left d-flex">
						<a href="/" class="btn__main"><i class="icon-chevron-left btn__icon me-6"></i>BACK</a>
					</div>	
					<div class="footer__right d-flex align-items-center">
						<div class="order__id me-24">ORDER ID: 1B28266H</div>
						<form id="next-form" action="/ordersnacks" method="post">
							<input type="hidden" name="qty1" id="form-qty-1" value="0">
							<input type="hidden" name="qty2" id="form-qty-2" value="0">
							<input type="hidden" name="qty3" id="form-qty-3" value="0">
							<button type="submit" class="btn__main">ADD SNACKS<i class="icon-chevron-right btn__icon ms-6"></i></button>
						</form>
					</div>
				</div>	
			</footer>
		</div>
	</body>

	<!-- ======= Embedding JSON into HTML ======= -->
	<script id="unit-price-data" type="application/json">{{ (unit_price_map or {}) | tojson | safe }}</script>
	<script id="preselected-popcorn" type="application/json">{{ (preselected_popcorn or {}) | tojson | safe }}</script>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
		/* ---------- Helpers ---------- */
			const readJSON = (id) => {
				const el = document.getElementById(id);
				if (!el) return {};
				try { return JSON.parse(el.textContent || "{}"); }
				catch { return {}; }
			};
			const getInt = (el) => parseInt(el?.textContent ?? "0", 10) || 0;

			/* ---------- 1. Load backend values ---------- */
			const priceMap = readJSON("unit-price-data");
  		const preselected = readJSON("preselected-popcorn");	

			/* ---------- 2. Assign data-unit on price blocks ---------- */
			document.querySelectorAll(".popcorn__block").forEach(block => {
				const title = block.querySelector(".title--two")?.textContent?.trim();
				const unit = priceMap[title];
				if (typeof unit !== "number") return;
				block.querySelectorAll(".popcorn__price")
					.forEach(p => p.dataset.unit = unit);
			});

			/* ---------- 3. Quantity â†’ Price updater ---------- */
			const updatePriceForQuantity = (targetId) => {
				const qtyEl = document.getElementById(targetId);
				if (!qtyEl) return;

				const qty = getInt(qtyEl);
				document.querySelectorAll(`.popcorn__price[data-qty-target="${targetId}"]`)
					.forEach(pc => {
						const unit = parseFloat(pc.dataset.unit || "0");
						const valueEl = pc.querySelector(".price-value");
						if (valueEl) valueEl.textContent = Math.max(0, Math.round(unit * qty));
					});
			};

			/* ---------- 4. Quantity increment/decrement ---------- */
			const updateQuantity = (id, delta) => {
				const el = document.getElementById(id);
				if (!el) return;
				el.textContent = Math.max(0, getInt(el) + delta);
				updatePriceForQuantity(id);
				updateItemsSelected();
			};

			for (const btn of document.querySelectorAll(".qty-plus")) {
				btn.addEventListener("click", () => updateQuantity(btn.dataset.target, 1));
			}

			for (const btn of document.querySelectorAll(".qty-minus")) {
				btn.addEventListener("click", () => updateQuantity(btn.dataset.target, -1));
			}

			/* ---------- 5. Preload backend quantities ---------- */
			for (const id in preselected) {
				const el = document.getElementById(id);
				if (!el) continue;
				el.textContent = preselected[id];
				updatePriceForQuantity(id);
			}

			/* ---------- 6. Update all prices once ---------- */
			document.querySelectorAll(".popcorn__qty[id]")
				.forEach(q => updatePriceForQuantity(q.id));


			/* ---------- 7. Cart total items ---------- */
			const updateItemsSelected = () => {
				let total = 0;
				for (const q of document.querySelectorAll(".popcorn__qty[id]")) {
					total += getInt(q);
				}
				const t = document.getElementById("items-selected-count");
				if (t) t.textContent = total;
			};
			updateItemsSelected();
			
			/* ---------- 8. Sync hidden fields before submit ---------- */
			const form = document.getElementById("next-form");
			if (form) {
				form.addEventListener("submit", () => {
					["1", "2", "3"].forEach(num => {
						const q = document.getElementById(`qty-${num}`);
						const f = document.getElementById(`form-qty-${num}`);
						if (f && q) f.value = getInt(q);
					});
				});
			}

		});
	</script>

	<!-- ======= JS Script ======= -->
	<!-- <script>
		document.addEventListener('DOMContentLoaded', function () {
			// Set data-unit attribute of the price element from backend values
			try {
				var priceMap = {};
				var unitScript = document.getElementById('unit-price-data');
				if (unitScript) {
					priceMap = JSON.parse(unitScript.textContent || '{}');
				}
				if (priceMap && typeof priceMap === 'object') {
					document.querySelectorAll('.popcorn__block').forEach(function (container) {
						var title = (container.querySelector('.title--two')?.textContent || '').trim();
						var unit = priceMap[title];
						if (typeof unit === 'number') {
							container.querySelectorAll('.popcorn__price').forEach(function (p) {
									p.setAttribute('data-unit', String(unit));
							});
						}
					});
				}
			} catch (e) {}

			// Update prices based on quantity updates
			function updatePriceForQuantity(targetId) {
				var qtyEl = document.getElementById(targetId);
				if (!qtyEl) return;
				var qty = parseInt(qtyEl.textContent || qtyEl.innerText || '0', 10);
				if (isNaN(qty)) qty = 0;
				var priceContainers = document.querySelectorAll('.popcorn__price[data-qty-target="' + targetId + '"]');
				priceContainers.forEach(function(pc){
					var unit = parseFloat(pc.getAttribute('data-unit') || '0');
					var total = Math.max(0, Math.round(unit * qty));
					var valueEl = pc.querySelector('.price-value');
					if (valueEl) valueEl.textContent = String(total);
				});
			}

			// Update quantity on plus or minus button clicks
			function updateQuantity(targetId, delta) {
				var el = document.getElementById(targetId);
				if (!el) return;
				var value = parseInt(el.textContent || el.innerText || '0', 10);
				if (isNaN(value)) value = 0;
				value = value + delta;
				if (value < 0) value = 0;
				el.textContent = String(value);
				updatePriceForQuantity(targetId);
			}

			// Update quantity on plus button click
			var plusButtons = document.querySelectorAll('.qty-plus');
			plusButtons.forEach(function(btn){				
				btn.addEventListener('click', function(){
					var target = btn.getAttribute('data-target');
					if (target) updateQuantity(target, 1);
				});
			});

			// Update quantity on minus button click
			var minusButtons = document.querySelectorAll('.qty-minus');
			minusButtons.forEach(function(btn){
				btn.addEventListener('click', function(){
					var target = btn.getAttribute('data-target');
					if (target) updateQuantity(target, -1);
				});
			});

			// Initialize quantities from backend if available
			try {
				var preSel = {};
				var preScript = document.getElementById('preselected-popcorn');
				if (preScript) preSel = JSON.parse(preScript.textContent || '{}');
				Object.keys(preSel || {}).forEach(function(qid){
					var el = document.getElementById(qid);
					if (el) {
						var v = parseInt(preSel[qid] || 0, 10);
						if (!isNaN(v)) el.textContent = String(v);
						updatePriceForQuantity(qid);
					}
				});
			} catch (e) {}

			// Recompute for any remaining
			var qtySpans = document.querySelectorAll('.popcorn__qty[id]');
			qtySpans.forEach(function(q){ updatePriceForQuantity(q.id); });

			// Update cart quantity
			function updateItemsSelected(){
					var total = 0;
					document.querySelectorAll('.popcorn__qty[id]').forEach(function(q){
							var v = parseInt(q.textContent || q.innerText || '0', 10);
							if (!isNaN(v)) total += v;
					});
					var t = document.getElementById('items-selected-count');
					if (t) t.textContent = String(total);
			}
			updateItemsSelected();
			document.querySelectorAll('.qty-plus, .qty-minus').forEach(function(btn){
				btn.addEventListener('click', updateItemsSelected);
			});

			// Sync hidden form fields with current quantities on submit
			var form = document.getElementById('next-form');
			if (form) {
				form.addEventListener('submit', function(){
					var q1 = document.getElementById('qty-1');
					var q2 = document.getElementById('qty-2');
					var q3 = document.getElementById('qty-3');
					var f1 = document.getElementById('form-qty-1');
					var f2 = document.getElementById('form-qty-2');
					var f3 = document.getElementById('form-qty-3');
					if (q1 && f1) f1.value = (q1.textContent || q1.innerText || '0').trim();
					if (q2 && f2) f2.value = (q2.textContent || q2.innerText || '0').trim();
					if (q3 && f3) f3.value = (q3.textContent || q3.innerText || '0').trim();
				});
			}
			// 30s inactivity redirect to home
			/*try {
					var inactivityTimer = setTimeout(function(){ window.location.href = '/'; }, 30000);
					['click','keydown','touchstart'].forEach(function(evt){
							window.addEventListener(evt, function(){ clearTimeout(inactivityTimer); inactivityTimer = setTimeout(function(){ window.location.href = '/'; }, 30000); }, { passive: true });
					});
			} catch(e) {}*/
		});
	</script> -->
</html>